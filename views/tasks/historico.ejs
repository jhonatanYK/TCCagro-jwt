<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Serviços - Gestor de Serviços</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-900 text-white">
    <div class="min-h-screen flex flex-col justify-center items-center px-4 py-8">
      <div class="flex flex-col items-center mb-8">
        <svg class="w-16 h-16 mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h2 class="text-2xl font-bold text-slate-400">Histórico de Serviços</h2>
        <p class="text-gray-400 mt-2">Todos os serviços concluídos e finalizados</p>
      </div>

      <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-6xl border border-slate-600">
        
        <!-- Filtro de Clientes -->
        <div class="mb-6">
          <form method="GET" action="/tasks/history" class="flex items-center gap-4">
            <div class="flex-1">
              <label for="clientFilter" class="block text-sm font-medium text-gray-300 mb-2">
                Filtrar por Cliente
              </label>
              <select 
                id="clientFilter" 
                name="client" 
                onchange="this.form.submit()"
                class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                <option value="">Todos os Clientes</option>
                <% if (clients && clients.length > 0) { %>
                  <% clients.forEach(client => { %>
                    <option value="<%= client.clientName %>" <%= selectedClient === client.clientName ? 'selected' : '' %>>
                      <%= client.clientName %>
                    </option>
                  <% }); %>
                <% } %>
              </select>
            </div>
            <% if (selectedClient) { %>
              <div class="mt-6">
                <a 
                  href="/tasks/history" 
                  class="inline-block bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition-colors"
                >
                  Limpar Filtro
                </a>
              </div>
            <% } %>
          </form>
          
          <% if (selectedClient) { %>
            <div class="mt-3 text-sm text-gray-400">
              Exibindo <%= tasks.length %> serviço(s) de <span class="font-semibold text-slate-400"><%= selectedClient %></span>
            </div>
          <% } else { %>
            <div class="mt-3 text-sm text-gray-400">
              Exibindo <%= tasks.length %> serviço(s) no total
            </div>
          <% } %>
        </div>
        
        <% if (tasks.length === 0) { %>
          <!-- Mensagem quando não há histórico -->
          <div class="text-center py-12">
            <svg class="w-24 h-24 mx-auto mb-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-gray-400 text-lg mb-2">Nenhum serviço finalizado ainda</p>
            <p class="text-gray-500 text-sm">Os serviços aparecerão aqui após serem finalizados em "Ver Serviços"</p>
          </div>
        <% } else { %>
          <!-- Lista de Serviços Históricos (Formato Simples) -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-gray-700">
                  <th class="text-left py-3 px-4 text-slate-300">Cliente</th>
                  <th class="text-left py-3 px-4 text-slate-300">Serviço</th>
                  <th class="text-left py-3 px-4 text-slate-300">Máquina</th>
                  <th class="text-left py-3 px-4 text-slate-300">Horas</th>
                  <th class="text-left py-3 px-4 text-slate-300">Valor</th>
                  <th class="text-center py-3 px-4 text-slate-300">Status</th>
                </tr>
              </thead>
              <tbody>
                <% tasks.forEach(task => { %>
                  <tr class="border-b border-gray-700 hover:bg-gray-700">
                    <td class="py-3 px-4 text-white"><%= task.client.name %></td>
                    <td class="py-3 px-4 text-white">
                      <div class="font-semibold"><%= task.serviceName %></div>
                      <% if (task.location) { %>
                        <div class="text-xs text-gray-400"><%= task.location %><% if (task.locationNumber) { %>, <%= task.locationNumber %><% } %></div>
                      <% } %>
                    </td>
                    <td class="py-3 px-4 text-gray-300">
                      <% if (task.machines && task.machines.length > 0) { %>
                        <% task.machines.forEach(function(machine, index) { %>
                          <div class="<%= index > 0 ? 'mt-1 pt-1 border-t border-gray-600' : '' %>">
                            <%= machine.name %>
                          </div>
                        <% }); %>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td class="py-3 px-4 text-gray-300">
                      <% if (task.machines && task.machines.length > 0) { %>
                        <% task.machines.forEach(function(machine, index) { %>
                          <% const tm = machine.task_machine; %>
                          <div class="<%= index > 0 ? 'mt-1 pt-1 border-t border-gray-600' : '' %> text-sm">
                            <% if (tm && tm.endTime) { %>
                              <%= parseFloat(tm.hoursWorked).toFixed(1).replace('.', ',') %>h
                            <% } else { %>
                              -
                            <% } %>
                          </div>
                        <% }); %>
                      <% } else { %>
                        -
                      <% } %>
                    </td>
                    <td class="py-3 px-4 text-green-400">
                      <% 
                        let totalService = 0;
                        if (task.machines && task.machines.length > 0) {
                          task.machines.forEach(machine => {
                            if (machine.task_machine && machine.task_machine.totalAmount) {
                              totalService += parseFloat(machine.task_machine.totalAmount || 0);
                            }
                          });
                        }
                      %>
                      <span class="font-bold">R$ <%= totalService.toFixed(2).replace('.', ',') %></span>
                    </td>
                    <td class="py-3 px-4 text-center">
                      <span class="px-3 py-1 rounded-full text-xs font-semibold <%= task.paid ? 'bg-green-600 text-white' : 'bg-red-600 text-white' %>">
                        <%= task.paid ? '✓ Pago' : '❌ Não Pago' %>
                      </span>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>

        <!-- Paginação -->
        <% if (totalPages > 1) { %>
          <div class="mt-6 flex justify-center items-center gap-2">
            <!-- Botão Anterior -->
            <% if (currentPage > 1) { %>
              <a 
                href="/tasks/history?page=<%= currentPage - 1 %><%= selectedClient ? '&client=' + selectedClient : '' %>"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors"
              >
                ← Anterior
              </a>
            <% } else { %>
              <span class="px-4 py-2 bg-gray-800 text-gray-500 rounded-lg cursor-not-allowed">
                ← Anterior
              </span>
            <% } %>

            <!-- Números das páginas -->
            <div class="flex gap-1">
              <% 
                const maxButtons = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
                let endPage = Math.min(totalPages, startPage + maxButtons - 1);
                
                if (endPage - startPage + 1 < maxButtons) {
                  startPage = Math.max(1, endPage - maxButtons + 1);
                }
              %>
              
              <% if (startPage > 1) { %>
                <a 
                  href="/tasks/history?page=1<%= selectedClient ? '&client=' + selectedClient : '' %>"
                  class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors"
                >
                  1
                </a>
                <% if (startPage > 2) { %>
                  <span class="px-3 py-2 text-gray-500">...</span>
                <% } %>
              <% } %>
              
              <% for (let i = startPage; i <= endPage; i++) { %>
                <% if (i === currentPage) { %>
                  <span class="px-3 py-2 bg-slate-600 text-white rounded font-bold border-2 border-slate-400">
                    <%= i %>
                  </span>
                <% } else { %>
                  <a 
                    href="/tasks/history?page=<%= i %><%= selectedClient ? '&client=' + selectedClient : '' %>"
                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors"
                  >
                    <%= i %>
                  </a>
                <% } %>
              <% } %>
              
              <% if (endPage < totalPages) { %>
                <% if (endPage < totalPages - 1) { %>
                  <span class="px-3 py-2 text-gray-500">...</span>
                <% } %>
                <a 
                  href="/tasks/history?page=<%= totalPages %><%= selectedClient ? '&client=' + selectedClient : '' %>"
                  class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors"
                >
                  <%= totalPages %>
                </a>
              <% } %>
            </div>

            <!-- Botão Próximo -->
            <% if (currentPage < totalPages) { %>
              <a 
                href="/tasks/history?page=<%= currentPage + 1 %><%= selectedClient ? '&client=' + selectedClient : '' %>"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors"
              >
                Próximo →
              </a>
            <% } else { %>
              <span class="px-4 py-2 bg-gray-800 text-gray-500 rounded-lg cursor-not-allowed">
                Próximo →
              </span>
            <% } %>
          </div>

          <!-- Informação de página -->
          <div class="mt-3 text-center text-sm text-gray-400">
            Página <%= currentPage %> de <%= totalPages %> (Total: <%= totalCount %> serviços)
          </div>
        <% } %>

        <!-- Botões de Navegação -->
        <div class="mt-8 flex flex-col gap-3">
          <a
            href="/dashboard"
            class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition duration-200 border-2 border-gray-600 text-center shadow-md hover:shadow-lg"
          >
            Voltar ao Painel
          </a>
        </div>
      </div>
    </div>

    <script>
      (function() {
        // Desabilita o botão voltar após logout - verifica se página veio do cache
        window.addEventListener('pageshow', function(event) {
          if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
            // Página foi restaurada do cache - verifica autenticação
            fetch('/api/check-auth', {
              method: 'GET',
              credentials: 'include'
            })
            .then(response => {
              if (!response.ok) {
                window.location.replace('/login');
              }
            })
            .catch(() => {
              window.location.replace('/login');
            });
          }
        });
      })();
    </script>
  </body>
</html>
